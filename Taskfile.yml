version: "3"

tasks:
  default:
    cmds:
      - task: dev

  install:
    desc: Install dependencies
    cmds:
      - cd frontend && bun install
      - cd server && go mod download

  docs:
    desc: Generate OpenAPI documentation
    dir: server
    cmds:
      - go run github.com/swaggo/swag/v2/cmd/swag init -g cmd/gravity/main.go --v3.1 --parseInternal --ot yml
      - mv docs/swagger.yaml docs/openapi.yml

  dev:
    desc: Run development server
    deps: [install]
    cmds:
      - task: dev:frontend
      - task: dev:backend

  tidy:
    desc: Go Tidy
    dir: server
    cmd: go mod tidy

  ui:gen:
    desc: Generate OpenAPI Types
    cmd: bunx openapi-typescript ./server/docs/openapi.yml -o ./frontend/src/gen/api.d.ts

  dev:frontend:
    dir: frontend
    cmd: bun run dev

  dev:backend:
    dir: server
    cmd: go run ./cmd/gravity

  build:
    desc: Build for production
    deps: [build:frontend, build:backend]

  build:frontend:
    dir: frontend
    cmd: bun run build

  build:backend:
    dir: server
    cmd: go build -ldflags="-s -w" -o ../bin/gravity cmd/gravity/main.go

  test:
    desc: Run tests
    cmds:
      - task: test:backend
      - task: test:frontend

  test:backend:
    dir: server
    cmd: go test ./...

  test:frontend:
    dir: frontend
    cmd: bun run test

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf server/internal/app/dist
      - rm -rf bin/
